<script>
  window.onload = () => {
    let previous = null;

    document.getElementById('light-theme').addEventListener('change', () => {
      document.body.classList.remove('dark-theme');
    });

    document.getElementById('dark-theme').addEventListener('change', () => {
      document.body.classList.add('dark-theme');
    });

    const chart = Highcharts.chart("chart", {
      chart: {
        type: "spline",
        animation: Highcharts.svg,
        backgroundColor: "transparent",
        marginRight: 10
      },
      title: {
        text: "Real-time Traffic Monitor",
        style: { color: "#333", fontSize: "20px" }
      },
      xAxis: {
        type: 'datetime',
        tickPixelInterval: 150,
        labels: { style: { color: '#666' } }
      },
      yAxis: {
        title: {
          text: "Requests / Sec",
          style: { color: "#666" }
        },
        plotLines: [{
          value: 0,
          width: 1,
          color: '#808080'
        }],
        labels: { style: { color: '#666' } }
      },
      tooltip: {
        formatter: function () {
          return '<b>' + this.series.name + '</b><br/>' +
            Highcharts.dateFormat('%H:%M:%S', this.x) + '<br/>' +
            Highcharts.numberFormat(this.y, 0) + ' req/s';
        }
      },
      legend: { enabled: false },
      exporting: { enabled: false },
      credits: { enabled: false },
      series: [{
        name: 'Traffic',
        data: []
      }]
    });

    function fetchData() {
      fetch("/nginx_status")
        .then(res => res.text())
        .then(text => {
          const part = text.split(' ')[9];
          const current = parseInt(part);
          const now = (new Date()).getTime();

          if (!isNaN(current) && current > 0 && (previous === null || (current - previous > 0 && current - previous < 9999999))) {
            const value = previous === null ? 0 : current - previous;
            const series = chart.series[0];
            const shift = series.data.length > 60;
            series.addPoint([now, value], true, shift);
            previous = current;
          } else {
            previous = null;
          }
        })
        .catch(err => console.log("Fetch Error:", err))
        .finally(() => {
          setTimeout(fetchData, 1000);
        });
    }

    fetchData();

    function makeResizable(elem, handle) {
      $(handle).on("mousedown", function (e) {
        const startWidth = elem.width(), startHeight = elem.height();
        const startX = e.pageX, startY = e.pageY;
        $(document).on("mousemove", function (e) {
          const newWidth = startWidth + e.pageX - startX;
          const newHeight = startHeight + e.pageY - startY;
          elem.width(newWidth);
          elem.height(newHeight);
          chart.setSize(newWidth, newHeight);
        }).on("mouseup", function () {
          $(document).off("mousemove mouseup");
        });
      });
    }

    makeResizable($("#chart"), "#bottom-right");
  };
</script>
